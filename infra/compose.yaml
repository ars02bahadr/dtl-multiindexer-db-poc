services:
  # --- Blockchain Network (Hyperledger Besu QBFT) ---
  validator1:
    image: hyperledger/besu:24.3
    user: "0:0"
    container_name: dtl-validator1
    environment:
      - BESU_PUBLIC_KEY_DIRECTORY=/opt/besu/keys
    command:
      [
        "--config-file=/config/config.toml",
        "--genesis-file=/config/genesis.json",
        "--rpc-http-enabled=true",
        "--rpc-http-host=0.0.0.0",
        "--rpc-http-port=8545",
        "--rpc-http-cors-origins=*",
        "--host-allowlist=*",
        "--rpc-http-api=ETH,NET,WEB3,QBFT,ADMIN,TXPOOL",
        "--rpc-ws-enabled=true",
        "--rpc-ws-host=0.0.0.0",
        "--rpc-ws-port=8546",
        "--rpc-ws-api=ETH,NET,WEB3,QBFT,ADMIN,TXPOOL",
        "--p2p-port=30303",
        "--min-gas-price=0",
      ]
    volumes:
      - ./besu/config.toml:/config/config.toml
      - ./besu/genesis.json:/config/genesis.json
      - ./besu/static-nodes.json:/opt/besu/data/static-nodes.json
      - ./besu/keys/validator1/key:/opt/besu/data/key
      - besu-validator1-data:/opt/besu/data
    ports:
      - "8545:8545"
      - "8546:8546"
      - "8547:8547"
    networks:
      dtl-net:
        ipv4_address: 172.16.239.11

  validator2:
    image: hyperledger/besu:24.3
    user: "0:0"
    container_name: dtl-validator2
    command:
      [
        "--config-file=/config/config.toml",
        "--genesis-file=/config/genesis.json",
        "--p2p-port=30303",
        "--rpc-http-enabled=true",
        "--rpc-http-host=0.0.0.0",
        "--rpc-http-port=8545",
        "--rpc-http-cors-origins=*",
        "--min-gas-price=0",
      ]
    volumes:
      - ./besu/config.toml:/config/config.toml
      - ./besu/genesis.json:/config/genesis.json
      - ./besu/static-nodes.json:/opt/besu/data/static-nodes.json
      - ./besu/keys/validator2/key:/opt/besu/data/key
      - besu-validator2-data:/opt/besu/data
    ports:
      - "8555:8545"
    networks:
      dtl-net:
        ipv4_address: 172.16.239.12

  validator3:
    image: hyperledger/besu:24.3
    user: "0:0"
    container_name: dtl-validator3
    command:
      [
        "--config-file=/config/config.toml",
        "--genesis-file=/config/genesis.json",
        "--p2p-port=30303",
        "--rpc-http-enabled=false",
        "--rpc-ws-enabled=false",
        "--min-gas-price=0",
      ]
    volumes:
      - ./besu/config.toml:/config/config.toml
      - ./besu/genesis.json:/config/genesis.json
      - ./besu/static-nodes.json:/opt/besu/data/static-nodes.json
      - ./besu/keys/validator3/key:/opt/besu/data/key
      - besu-validator3-data:/opt/besu/data
    networks:
      dtl-net:
        ipv4_address: 172.16.239.13

  validator4:
    image: hyperledger/besu:24.3
    user: "0:0"
    container_name: dtl-validator4
    command:
      [
        "--config-file=/config/config.toml",
        "--genesis-file=/config/genesis.json",
        "--p2p-port=30303",
        "--rpc-http-enabled=false",
        "--rpc-ws-enabled=false",
        "--min-gas-price=0",
      ]
    volumes:
      - ./besu/config.toml:/config/config.toml
      - ./besu/genesis.json:/config/genesis.json
      - ./besu/static-nodes.json:/opt/besu/data/static-nodes.json
      - ./besu/keys/validator4/key:/opt/besu/data/key
      - besu-validator4-data:/opt/besu/data
    networks:
      dtl-net:
        ipv4_address: 172.16.239.14

  # --- Storage (IPFS) ---
  ipfs0:
    image: ipfs/kubo:latest
    container_name: dtl-ipfs
    environment:
      - IPFS_SWARM_KEY_FILE=/swarm/swarm.key
      - IPFS_PROFILE=server
    entrypoint: /bin/sh
    command:
      - -c
      - |
        ipfs init --profile=server || true
        ipfs config AutoConf.Enabled false
        ipfs config --json Swarm.EnableAutoRelay false
        ipfs config --json Swarm.RelayClient.Enabled false
        ipfs config Addresses.API /ip4/0.0.0.0/tcp/5001
        ipfs config Addresses.Gateway /ip4/0.0.0.0/tcp/8080
        ipfs daemon --migrate=true
    volumes:
      - ./ipfs/swarm.key:/swarm/swarm.key:ro
      - ipfs-data:/data/ipfs
    ports:
      - "4001:4001"
      - "5001:5001"
      - "8080:8080"
    networks:
      dtl-net:

  # --- Database (Postgres & Redis) ---
  db:
    image: postgres:15-alpine
    container_name: dtl-postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: dtl_db
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      dtl-net:

  redis:
    image: redis:7-alpine
    container_name: dtl-redis
    ports:
      - "6379:6379"
    networks:
      dtl-net:

  # --- Scheduler (Go - Hangfire-like) ---
  scheduler:
    build:
      context: ../scheduler
      dockerfile: Dockerfile
    container_name: dtl-scheduler
    environment:
      - BESU_RPC_URL=http://dtl-validator1:8545
      - SCHEDULER_INTERVAL=10s
      - LOG_FILE=/app/logs/blockchain_report.txt
    volumes:
      - ../scheduler/logs:/app/logs
    depends_on:
      - validator1
    restart: unless-stopped
    networks:
      dtl-net:

networks:
  dtl-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.239.0/24

volumes:
  besu-validator1-data:
  besu-validator2-data:
  besu-validator3-data:
  besu-validator4-data:
  ipfs-data:
  postgres-data:
